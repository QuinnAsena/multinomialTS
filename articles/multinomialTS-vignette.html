<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>multinomialTS Vignette • multinomialTS</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="multinomialTS-vignette_files/libs/quarto-html/popper.min.js"></script><script src="multinomialTS-vignette_files/libs/quarto-html/tippy.umd.min.js"></script><link href="multinomialTS-vignette_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="multinomialTS-vignette_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="multinomialTS Vignette">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">multinomialTS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/multinomialTS-vignette.html">multinomialTS Vignette</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>multinomialTS Vignette</h1>





      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>One of the primary goals of this model is to be able to test multiple hypotheses about the data and lend statistical support to the different hypotheses. For example which environmental drivers are having the strongest effects on which taxa? Or, are interactions among taxa or abiotic variables driving change in the system? This state-space approach allows us to estimate coefficients for taxa interactions and driver-taxa relationships, that we don’t get from methods such as ordination or cluster analysis. We recommend this method as complimentary to other methods, as both have their advantages.</p>
<section class="level2"><h3 id="this-vignette">This vignette<a class="anchor" aria-label="anchor" href="#this-vignette"></a>
</h3>
<p>This vignette will take us through:</p>
<ul>
<li>Choosing a binning resolution for <code><a href="../reference/mnTS.html">mnTS()</a></code>
</li>
<li>Finding initial conditions with <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code>
</li>
<li>Fitting <code><a href="../reference/mnTS.html">mnTS()</a></code> with and without species interactions</li>
<li>assess the resulting models</li>
</ul></section></section><section class="section level2"><h2 id="fitting-mnts">Fitting <code>mnTS()</code>
<a class="anchor" aria-label="anchor" href="#fitting-mnts"></a>
</h2>
<p>This vignette will work with the data that have focal taxa and groups already wrangled. A second vignette will be added to cover the data wrangling, for now see <embed src="https://quinnasena.github.io/state-space-workhop-ESA/state-space-walkthrough.html"></embed></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RcppCore/RcppArmadillo" class="external-link">RcppArmadillo</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://optimizer.r-forge.r-project.org" class="external-link">minqa</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HenrikBengtsson/matrixStats" class="external-link">matrixStats</a></span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'matrixStats'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    count</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://optimizer.r-forge.r-project.org/" class="external-link">numDeriv</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mvtnorm.R-forge.R-project.org" class="external-link">mvtnorm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://quinnasena.github.io/multinomialTS/">multinomialTS</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read-in the wrangled data </span></span>
<span><span class="co"># Read in our X variables</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"story_char_wide"</span>, package <span class="op">=</span> <span class="st">"multinomialTS"</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in data("story_char_wide", package = "multinomialTS"): data set
'story_char_wide' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read in the long data for plotting</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"story_pollen_wide"</span>, package <span class="op">=</span> <span class="st">"multinomialTS"</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in data("story_pollen_wide", package = "multinomialTS"): data set
'story_pollen_wide' not found</code></pre>
</div>
</div>
<p>Here is what the state variable (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>) data look like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">story_pollen_wide</span><span class="op">)</span></span></code></pre></div>
</div>
<p>And our covariate (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">story_char_wide</span><span class="op">)</span></span></code></pre></div>
</div>
<p>For the moment, we are keeiping the age and depth columns in both tibbles. These columns are so that we have a common variable to match the two to tibbles, and will be removed a little lates.</p>
<section class="level2"><h3 id="state-variables-y">State variables <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math><a class="anchor" aria-label="anchor" href="#state-variables-y"></a>
</h3>
<p>We will start off by chosing a resolution for the model predictions (<em>e.g.,</em> predicting ecological process at 50 or 100 year intervals).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Time-span of the data divided by the numer of observations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">story_pollen_wide</span><span class="op">$</span><span class="va">age</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">story_pollen_wide</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Age differences between successive observations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">story_pollen_wide</span><span class="op">$</span><span class="va">age</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># The range of the age differences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">story_pollen_wide</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the average of the age differences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">story_pollen_wide</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">story_pollen_wide</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<p>This all looks great! If we bin the data at around 50-75 years, we will still have most of our data in independent bins.</p>
<p>Now that we know roughly what bin-width to use to maximise the number of observations in the state variables, we will apply the same bin-width to both the state variables and the covariate data.</p>
<div>
<blockquote>
<p><strong>Ask me questions!</strong></p>
<p>What questions do you have so far?</p>
</blockquote>
</div>
</section><section class="level2"><h3 id="handling-the-covariates-x">Handling the covariates <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math><a class="anchor" aria-label="anchor" href="#handling-the-covariates-x"></a>
</h3>
<p>Covariates need to be handled according to decisions that were made around the state variables, that is, if the state variables were binned at a century-level resolution then the covariates must match that resolution. We <em>can</em> have a finer temporal resolution of the covariates than we do of the state variables. In this dataset, our state variables have r nrow(story_pollen_wide) observations, and our covariate has r nrow(story_char_wide[story_char_wide<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>g</mi><mi>e</mi><mo>&lt;</mo><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false" form="prefix">(</mo><mi>s</mi><mi>t</mi><mi>o</mi><mi>r</mi><msub><mi>y</mi><mi>p</mi></msub><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><msub><mi>n</mi><mi>w</mi></msub><mi>i</mi><mi>d</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">age &lt;= max(story_pollen_wide</annotation></semantics></math>age), ]) observations over the same time-span. Having more observations of environmental covariates is common in palaeo-data and works well with fitting the model.</p>
<p>Since we need to apply the same binning procedure to both the state variables and the covariate, I like to join both datasets. Charcoal was sampled to a greater depth than the pollen data, so we are going to clip the covariate to the extent of the state variables and join the two datasets by their common variable, age.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clip covariate data to the extent of the state variables</span></span>
<span><span class="co"># Join the two by age so that we get a square matrix</span></span>
<span><span class="va">story_join</span> <span class="op">&lt;-</span> <span class="va">story_char_wide</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">story_pollen_wide</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">story_pollen_wide</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Always double check dimensions before/after joining!</span></span>
<span><span class="co"># dim(story_join)</span></span>
<span><span class="co"># tail(story_join)</span></span></code></pre></div>
</div>
<p>Now we have all our data joined. Note that the covariate <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> (<code>char_acc</code>) has observations every cm, whereas pollen was sampled at less frequent intervals (this is OK! :smiley:).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">story_join</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<p>I always do lots of quick checks like <code><a href="https://rdrr.io/r/utils/head.html" class="external-link">head()</a></code>, <code><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail()</a></code>, <code><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim()</a></code> (and many more!) to make sure to catch any coding mistakes!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">story_join</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<p>This all looks good, and we can now bin the data to an appropriate temporal resolution for fitting the model. Chosing a bin-width may take some trial and error, I’m going with a bin-width of 50 years.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This code chunks the data into bins and gives us a grouping variable "bins"</span></span>
<span></span>
<span><span class="va">bin_width</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">bins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">story_join</span><span class="op">$</span><span class="va">age</span>,</span>
<span>            breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">story_join</span><span class="op">$</span><span class="va">age</span><span class="op">)</span>,</span>
<span>            to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">story_join</span><span class="op">$</span><span class="va">age</span> <span class="op">+</span> <span class="va">bin_width</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="va">bin_width</span><span class="op">)</span>, include.lowest <span class="op">=</span> <span class="cn">TRUE</span>, labels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We now apply the bins to our data. For most types of covariates we want the <em>average</em> value of the covariate in each bin. But for the pollen count data, we want the <em>sum</em>. This is because of the underlying multinomial distribution in the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The following code </span></span>
<span><span class="va">story_binned</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="va">bins</span>, <span class="va">story_join</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">bins</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># Group the data by the bins so that we calculate per time bin</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">age</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="co"># the center of the bin</span></span>
<span>    char_acc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">char_acc</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="co"># mean charcoal accumulation rate per bin</span></span>
<span>    other <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">other</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="co"># the sums of the count data</span></span>
<span>    hardwood <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">hardwood</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>    `Fagus grandifolia` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`Fagus grandifolia`</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>    Ulmus <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Ulmus</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>    Quercus <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Quercus</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Be aware that the gaps in the pollen data are now filled with 0's not NA</span></span></code></pre></div>
</div>
<p>Let’s see what the data look like binned at a 50 year resolution:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">story_binned</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<p>This is looking good, we have reduced the time-intervals over which to run the model. The data are nowr nrow(story_binned rows with complete covariate data, containingr nrow(story_binned[which(rowSums(story_binned[ ,4:7]) != 0), ]) state variable observations. The original number of pollen observations was r nrow(story_pollen_wide), so we have not summed many observations within the same bins.</p>
<p><code>multinomialTS</code> requires two matrices, a site-by-species matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>, and a covariate matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>, so we will leave <code>tibbles</code> behind and split the data. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> variables may be of different types (e.g., continuous, categorical…) but should be scaled relative to each other.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">story_pollen_matrix</span> <span class="op">&lt;-</span> <span class="va">story_binned</span> <span class="op">|&gt;</span>  <span class="co"># Select taxa</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">other</span>, <span class="va">hardwood</span>, <span class="va">Ulmus</span>, <span class="va">`Fagus grandifolia`</span>, <span class="va">Quercus</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"Fagus"</span> <span class="op">=</span> <span class="st">"Fagus grandifolia"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Replacing 0 with NA is not strictly necessary the way we use the data today</span></span>
<span><span class="co"># But it is a good safety to avoid 0-count data where it zhould be no observation</span></span>
<span><span class="va">story_pollen_matrix</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">story_pollen_matrix</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">story_pollen_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="va">story_char_matrix_scaled</span> <span class="op">&lt;-</span> <span class="va">story_binned</span> <span class="op">|&gt;</span> <span class="co"># select covariates</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">char_acc</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Scale covariates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">story_char_matrix_scaled</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level2"><h3 id="fitting-multinomialts">Fitting <code>multinomialTS</code>
<a class="anchor" aria-label="anchor" href="#fitting-multinomialts"></a>
</h3>
<p>Ok, now we have:</p>
<ul>
<li>Chosen a temporal resolution for the model of r bin_width year bins</li>
<li>Organised the data into a site-by-species matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> at r bin_width year bins</li>
<li>Binned and scaled covariate matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
</li>
</ul>
<p>With that, we can fit the model.</p>
<section class="level3"><h4 id="finding-initial-conditions-using-mnglmm">Finding initial conditions using <code>mnGLMM()</code>
<a class="anchor" aria-label="anchor" href="#finding-initial-conditions-using-mnglmm"></a>
</h4>
<p>The <code><a href="../reference/mnTS.html">mnTS()</a></code> function will provide estimates for biotic interactions (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math> matrix), taxa-driver relationships (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> matrix), and cross-correlated error (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math> matrix). But the model needs initial starting values for these parameters to begin with. We get initial starting conditions from the data by running the <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code> funcion. <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code> returns estimates for the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math> matrices (not the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math> matrix) and assumes that there are no time gaps in the data.</p>
<div>
<blockquote>
<p><strong>Tip</strong></p>
<p>The arguments of the <em>starting</em> values in both the <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code> and <code><a href="../reference/mnTS.html">mnTS()</a></code> are all suffixed with <code>.start</code> (e.g., <code>B.start</code> will be the starting values for the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> matrix).</p>
<p>The arguments of the parameters to be <em>estimated</em> are all suffixed with <code>.fixed</code> (e.g., <code>B.fixed</code> will be parameters that are estimated from <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> matrix).</p>
</blockquote>
</div>
<section class="level4"><h5 id="setting-up-parameters-for-mngmll">Setting-up parameters for <code>mnGMLL()</code>
<a class="anchor" aria-label="anchor" href="#setting-up-parameters-for-mngmll"></a>
</h5>
<p>Now, lets set up the parameters for <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code>. We need:</p>
<ul>
<li>A vector that indicates the row indices where there are state variable observations: <code>sample_idx</code>
</li>
<li>An integer number of covariates (+ 1 for <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code>): <code>p</code>
</li>
<li>An integer of the number of state variables: <code>n</code>
</li>
<li>A matrix of starting values for <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>: <code>B.start.glmm</code>
</li>
<li>A matrix of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> parameters to estimate: <code>B.fixed.glmm</code>
</li>
<li>A matrix of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math> parameters to estimate: <code>V.fixed.glmm</code>
</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set-up sample index</span></span>
<span><span class="va">sample_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">story_pollen_matrix</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co"># make sure it works</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">story_pollen_matrix</span><span class="op">[</span><span class="va">sample_idx</span>, <span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Set-up the remaining parameters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set-up parameters</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">story_char_matrix_scaled</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span> <span class="co"># Number of independent variables plus intercept</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">story_pollen_matrix</span><span class="op">)</span> <span class="co"># number of taxa</span></span>
<span><span class="va">V.fixed.glmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">V.fixed.glmm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">V.fixed.glmm</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">B.fixed.glmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">p</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span>, <span class="va">p</span>, <span class="va">n</span><span class="op">)</span> <span class="co"># reference taxa [,1] are set to 0</span></span>
<span><span class="va">B.start.glmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">p</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">.01</span>, <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span>, <span class="va">p</span>, <span class="va">n</span><span class="op">)</span> <span class="co"># reference taxa [,1] are set to 0</span></span></code></pre></div>
</div>
<p>These parameters are used as arguments to the <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code> function. Check them out by printing them in your console. Each matrix needs to be the correct dimensions given the number of taxa and number of covariates. The position elements of each matrix reflect the species and/or the covariates, as we will see later in the output of the model.</p>
</section><section class="level4"><h5 id="fitting-mnglmm">Fitting <code>mnGLMM()</code>
<a class="anchor" aria-label="anchor" href="#fitting-mnglmm"></a>
</h5>
<p>Remember that <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code> does not handle gaps in the data and only fits complete <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> matrices. We have created a variable for out observation indices (<code>sample_idx</code>), so for <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code> we will index the matrices by this variable: e.g., <code>story_pollen_matrix[sample_idx, ]</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fit glmm</span></span>
<span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">glmm_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mnGLMM.html">mnGLMM</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">story_pollen_matrix</span><span class="op">[</span><span class="va">sample_idx</span>, <span class="op">]</span>,</span>
<span>                   X <span class="op">=</span> <span class="va">story_char_matrix_scaled</span><span class="op">[</span><span class="va">sample_idx</span>, ,drop <span class="op">=</span> <span class="cn">F</span><span class="op">]</span>,</span>
<span>                   B.start <span class="op">=</span> <span class="va">B.start.glmm</span>,</span>
<span>                   B.fixed <span class="op">=</span> <span class="va">B.fixed.glmm</span>,</span>
<span>                   V.fixed <span class="op">=</span> <span class="va">V.fixed.glmm</span><span class="op">)</span></span>
<span><span class="va">end_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">glmm_mod</span>, <span class="st">"./outputs/glmm_mod.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The outputs of <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code> can be examined with the <code>summary(glmm_mod)</code> and <code>coef(glmm_mod)</code> functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glmm_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"./outputs/glmm_mod.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">glmm_mod</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level4"><h5 id="setting-up-parameters-for-mnts">Setting-up parameters for <code>mnTS()</code>
<a class="anchor" aria-label="anchor" href="#setting-up-parameters-for-mnts"></a>
</h5>
<p>Now, lets set up the parameters for <code><a href="../reference/mnTS.html">mnTS()</a></code>. <code>mTS()</code> needs:</p>
<ul>
<li>row indices as before: <code>sample_idx</code>
</li>
<li>the number of covariates: <code>p</code>
</li>
<li>the number of state variables: <code>n</code>
</li>
<li>starting values for each matrix:
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>O</mi></mrow><annotation encoding="application/x-tex">BO</annotation></semantics></math>: <code>B0.start.mnTS</code> (intercept)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>: <code>B.start.mnTS</code> (driver-taxa)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>: <code>C.start.mnTS</code> (taxa interactions)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>: <code>V.start.mnTS</code> (cross-correlated error)</li>
</ul>
</li>
<li>parameters to estimate for each matrix:
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>O</mi></mrow><annotation encoding="application/x-tex">BO</annotation></semantics></math>: <code>B0.fixed.mnTS</code>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>: <code>B.fixed.mnTS</code>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>: <code>C.fixed.mnTS</code>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>: <code>V.fixed.mnTS</code>
</li>
</ul>
</li>
</ul>
<p>We are using the output from <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code> as starting values for the matrices <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mn>0</mn></mrow><annotation encoding="application/x-tex">B0</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>, and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>. <code><a href="../reference/mnGLMM.html">mnGLMM()</a></code> does not provide estimates for <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>, so we handle <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math> a little differently and we input values close to zero for each parameter estimated and let <code><a href="../reference/mnTS.html">mnTS()</a></code> do the rest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># B.start etc</span></span>
<span><span class="va">B0.start.mnTS</span> <span class="op">&lt;-</span> <span class="va">glmm_mod</span><span class="op">$</span><span class="va">B</span><span class="op">[</span><span class="fl">1</span>, , drop <span class="op">=</span> <span class="cn">F</span><span class="op">]</span></span>
<span><span class="va">B.start.mnTS</span> <span class="op">&lt;-</span> <span class="va">glmm_mod</span><span class="op">$</span><span class="va">B</span><span class="op">[</span><span class="fl">2</span>, , drop <span class="op">=</span> <span class="cn">F</span><span class="op">]</span></span>
<span></span>
<span><span class="va">sigma.start.mnTS</span> <span class="op">&lt;-</span> <span class="va">glmm_mod</span><span class="op">$</span><span class="va">sigma</span></span>
<span></span>
<span><span class="va">V.fixed.mnTS</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">n</span>, <span class="va">n</span><span class="op">)</span> <span class="co"># Covariance matrix of environmental variation in process eq</span></span>
<span><span class="va">V.fixed.mnTS</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">V.start.mnTS</span> <span class="op">=</span> <span class="va">V.fixed.mnTS</span></span>
<span><span class="va">V.start.mnTS</span> <span class="op">&lt;-</span> <span class="va">glmm_mod</span><span class="op">$</span><span class="va">V</span></span>
<span></span>
<span><span class="va">B.fixed.mnTS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">p</span><span class="op">-</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">B.fixed.mnTS</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">B0.fixed.mnTS</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span>, ncol <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set-up C without interactions</span></span>
<span><span class="va">C.start.mnTS</span> <span class="op">=</span> <span class="fl">.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">C.fixed.mnTS</span> <span class="op">&lt;-</span> <span class="va">C.start.mnTS</span></span>
<span><span class="va">C.fixed.mnTS</span><span class="op">[</span><span class="va">C.fixed.mnTS</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># Set-up C with interactions between Fagus and Quercus</span></span>
<span><span class="va">C.start.int.mnTS</span> <span class="op">=</span> <span class="fl">.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">C.start.int.mnTS</span><span class="op">[</span><span class="fl">5</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.001</span></span>
<span><span class="va">C.start.int.mnTS</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.001</span></span>
<span><span class="va">C.fixed.int.mnTS</span> <span class="op">&lt;-</span> <span class="va">C.start.int.mnTS</span></span>
<span><span class="va">C.fixed.int.mnTS</span><span class="op">[</span><span class="va">C.fixed.int.mnTS</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
</div>
</section><section class="level4"><h5 id="fitting-mnts-1">Fitting <code>mnTS()</code>
<a class="anchor" aria-label="anchor" href="#fitting-mnts-1"></a>
</h5>
<p>Remember, <code><a href="../reference/mnTS.html">mnTS()</a></code> <em>does</em> handle gaps in the state-variables where there are data in the covariate matrix. In the following code, we use the complete (no gaps) <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> matrix <code>story_pollen_matrix[sample_idx, ]</code> with dimensions: r dim(story_pollen_matrix[sample_idx, ]). And the full <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> matrix: <code>story_char_matrix_scaled</code> with dimensions: r dim(story_char_matrix_scaled) We will fit the model twice: - without taxa interactions - and without taxa interactions.</p>
<div class="panel-tabset">
<ul id="tabset-1" class="panel-tabset-tabby">
<li><a data-tabby-default="" href="#tabset-1-1">Without interactions</a></li>
<li><a href="#tabset-1-2">With interactions</a></li>
</ul>
<ul class="nav nav-tabs" id="NA" role="tablist"><li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#NA" id="NA-tab" type="button" role="tab" aria-controls="NA" aria-selected="true" class="active nav-link">
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mnTS_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mnTS.html">mnTS</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">story_pollen_matrix</span><span class="op">[</span><span class="va">sample_idx</span>, <span class="op">]</span>,</span>
<span>                 X <span class="op">=</span> <span class="va">story_char_matrix_scaled</span>, Tsample <span class="op">=</span> <span class="va">sample_idx</span>,</span>
<span>                 B0.start <span class="op">=</span> <span class="va">B0.start.mnTS</span>, B0.fixed <span class="op">=</span> <span class="va">B0.fixed.mnTS</span>,</span>
<span>                 B.start <span class="op">=</span> <span class="va">B.start.mnTS</span>, B.fixed <span class="op">=</span> <span class="va">B.fixed.mnTS</span>,</span>
<span>                 C.start <span class="op">=</span> <span class="va">C.start.mnTS</span>, C.fixed <span class="op">=</span> <span class="va">C.fixed.mnTS</span>,</span>
<span>                 V.start <span class="op">=</span> <span class="va">V.start.mnTS</span>, V.fixed <span class="op">=</span> <span class="va">V.fixed.mnTS</span>,</span>
<span>                 dispersion.fixed <span class="op">=</span> <span class="fl">1</span>, maxit.optim <span class="op">=</span> <span class="fl">1e+6</span><span class="op">)</span></span>
<span><span class="co"># maxit.optim is the max number of iterations the optimiser will complete before stopping.</span></span>
<span><span class="co"># increase maxit.optim if the model needs a lot of time to fit.</span></span>
<span><span class="va">end_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">mnTS_mod</span>, <span class="st">"./outputs/mnTS_mod.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
</button></li></ul>
<div class="tab-content"><div class="active  tab-pane" id="NA" role="tabpanel" aria-labelledby="NA-tab">

<div id="tabset-1-2">
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mnTS_mod_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mnTS.html">mnTS</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">story_pollen_matrix</span><span class="op">[</span><span class="va">sample_idx</span>, <span class="op">]</span>,</span>
<span>                     X <span class="op">=</span> <span class="va">story_char_matrix_scaled</span>, Tsample <span class="op">=</span> <span class="va">sample_idx</span>,</span>
<span>                     B0.start <span class="op">=</span> <span class="va">mnTS_mod</span><span class="op">$</span><span class="va">B0</span>, B0.fixed <span class="op">=</span> <span class="va">B0.fixed.mnTS</span>,</span>
<span>                     B.start <span class="op">=</span> <span class="va">mnTS_mod</span><span class="op">$</span><span class="va">B</span>, B.fixed <span class="op">=</span> <span class="va">B.fixed.mnTS</span>,</span>
<span>                     C.start <span class="op">=</span> <span class="va">mnTS_mod</span><span class="op">$</span><span class="va">C</span>, C.fixed <span class="op">=</span> <span class="va">C.fixed.int.mnTS</span>,</span>
<span>                     V.start <span class="op">=</span> <span class="va">mnTS_mod</span><span class="op">$</span><span class="va">V</span>, V.fixed <span class="op">=</span> <span class="va">V.fixed.mnTS</span>,</span>
<span>                     dispersion.fixed <span class="op">=</span> <span class="fl">1</span>, maxit.optim <span class="op">=</span> <span class="fl">1e+6</span><span class="op">)</span></span>
<span><span class="va">end_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">mnTS_mod_int</span>, <span class="st">"./outputs/mnTS_mod_int.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnTS_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"./outputs/mnTS_mod.rds"</span><span class="op">)</span></span>
<span><span class="va">mnTS_mod_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"./outputs/mnTS_mod_int.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div></div>
</div>
</section></section><section class="level3"><h4 id="interpreting-outputs">Interpreting outputs<a class="anchor" aria-label="anchor" href="#interpreting-outputs"></a>
</h4>
<p>The <code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code> and <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> functions will show the model outputs. Let’s check out the coefficients of interaction model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">mnTS_mod_int</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We have found that bootstrapping provides better estimates of standard erros (and subsequent P-values). The <code><a href="../reference/boot.html">boot()</a></code> function will bootstrap the model, but may take a very long time. We won’t do this today, but we strongly recommend bootstrapping your final models.</p>
</section><section class="level3"><h4 id="comparing-models">Comparing models<a class="anchor" aria-label="anchor" href="#comparing-models"></a>
</h4>
<p>The <code>summary</code> of the model provides both the log likelihood and the AIC (akaike information criterion). These can be used for comparing models. Today we will use the AIC. AIC is penalised for the number of parameters estimated, and so can be better for comparing models where one has more parameters estimated (i.e., the interaction model is estimating more parameters than the model without interactions).</p>
<p>The AIC (and log likelihood) values can be accessed directly with <code>mnTS_mod_int$AIC</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>without_interactions <span class="op">=</span> <span class="va">mnTS_mod</span><span class="op">$</span><span class="va">AIC</span>,</span>
<span>           with_interactions <span class="op">=</span> <span class="va">mnTS_mod_int</span><span class="op">$</span><span class="va">AIC</span><span class="op">)</span></span></code></pre></div>
</div>
</section></section></section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Quinn Asena.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
